<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fortune Cube</title>
  <style>
    html,body { height: 100%; margin: 0; }
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg,#0f0f14,#262627);
      overflow: hidden;
      font-family: Arial, Helvetica, sans-serif;
    }
    /* ensure color picker sits on top */
    input[type="color"] {
      position: absolute;
      display: none;
      z-index: 9999;
      width: 48px;
      height: 36px;
      padding: 0;
      border: none;
      background: transparent;
    }
    /* optional: small hint when color picker visible */
    #hint {
      position: absolute;
      color: #ddd;
      bottom: 18px;
      left: 18px;
      font-size: 13px;
      pointer-events: none;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <input id="colorPicker" type="color" value="#00ffff">
  <div id="hint">Click a cube face to change its color</div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
  <script>
    try {
      // Basic scene / camera / renderer
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
      camera.position.z = 3;

      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setPixelRatio(window.devicePixelRatio ? window.devicePixelRatio : 1);
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // Create a box with 6 separate materials (one per face)
      const geometry = new THREE.BoxGeometry(1.6, 1.6, 1.6);
      const faceMaterials = Array.from({length: 6}, () =>
        new THREE.MeshStandardMaterial({ color: 0x00ffff, metalness: 0.6, roughness: 0.25 })
      );
      const cube = new THREE.Mesh(geometry, faceMaterials);
      scene.add(cube);

      // Eyeball (smaller & recessed)
      const eyeGeometry = new THREE.SphereGeometry(0.22, 32, 32);
      const eyeMat = new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0x222222 });
      const eyeball = new THREE.Mesh(eyeGeometry, eyeMat);

      const pupilGeo = new THREE.SphereGeometry(0.07, 16, 16);
      const pupilMat = new THREE.MeshStandardMaterial({ color: 0x000000, metalness: 0.8, roughness: 0.3 });
      const pupil = new THREE.Mesh(pupilGeo, pupilMat);
      pupil.position.z = 0.12;
      eyeball.add(pupil);

      // Embed the eye slightly deeper so it doesn't poke out too much
      eyeball.position.set(0, 0, 0.55); // positioned relative to cube's local coords
      cube.add(eyeball);

      // Lights
      const point = new THREE.PointLight(0xffffff, 1.2);
      point.position.set(2, 2, 5);
      scene.add(point);
      scene.add(new THREE.AmbientLight(0x404040, 0.7));

      // Blink state
      let blink = 0;
      let blinking = false;
      setInterval(() => { blinking = true; }, 2500); // trigger blink every 2.5s

      // Raycaster + mouse for face clicking
      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2();
      const colorPicker = document.getElementById('colorPicker');
      let activeFaceIndex = -1;

      function onPointerDown(event) {
        // get normalized device coordinates
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObject(cube);
        if (intersects.length > 0) {
          // faceIndex refers to triangle index; each cube face has 2 triangles -> divide by 2
          const triIndex = intersects[0].faceIndex;
          const faceIndex = Math.floor(triIndex / 2);
          activeFaceIndex = faceIndex;
          // position and show the color input where the click happened
          colorPicker.style.left = event.clientX + 'px';
          colorPicker.style.top = event.clientY + 'px';
          colorPicker.style.display = 'block';
          colorPicker.focus();
        } else {
          // click missed the cube -> hide the picker
          colorPicker.style.display = 'none';
          activeFaceIndex = -1;
        }
      }

      // when user picks a color, set that face's material color
      colorPicker.addEventListener('input', (e) => {
        if (activeFaceIndex >= 0 && activeFaceIndex < faceMaterials.length) {
          faceMaterials[activeFaceIndex].color.set(e.target.value);
        }
      });

      // hide picker if user clicks elsewhere (and not on the input)
      window.addEventListener('pointerdown', (ev) => {
        // if clicking the color input itself, let it stay visible
        if (ev.target !== colorPicker) {
          // onPointerDown will handle showing/hiding; keep this as fallback
          // small delay to allow onPointerDown's logic to run first
          setTimeout(() => {
            if (document.activeElement !== colorPicker && colorPicker.style.display === 'block' && activeFaceIndex === -1) {
              colorPicker.style.display = 'none';
            }
          }, 10);
        }
      });

      // pointerdown on the window triggers raycast logic
      window.addEventListener('pointerdown', onPointerDown);

      // Animation loop
      function animate() {
        requestAnimationFrame(animate);

        // slow auto rotation
        cube.rotation.x += 0.007;
        cube.rotation.y += 0.01;

        // blinking (scale the eye's Y)
        if (blinking) {
          blink += 0.25;
          eyeball.scale.y = Math.abs(Math.cos(blink));
          if (blink > Math.PI) {
            blink = 0;
            blinking = false;
            eyeball.scale.y = 1;
          }
        }

        renderer.render(scene, camera);
      }
      animate();

      // responsiveness
      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      // quick console hint if something fails
      console.log('Fortune Cube running — click a face to change color.');
    } catch (err) {
      console.error('An error occurred while initializing the scene:', err);
      // show a minimal message so you know something broke
      const msg = document.createElement('div');
      msg.style.position = 'absolute';
      msg.style.left = '16px';
      msg.style.top = '16px';
      msg.style.color = 'red';
      msg.style.background = 'rgba(0,0,0,0.6)';
      msg.style.padding = '8px';
      msg.style.borderRadius = '6px';
      msg.textContent = 'Error: check console — scene failed to load.';
      document.body.appendChild(msg);
    }
  </script>
</body>
</html>
